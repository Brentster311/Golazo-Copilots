"""California Jack game state model."""

from dataclasses import dataclass, field
from typing import List, Optional

from game.models.card import Card
from game.models.deck import Deck


@dataclass
class CaliforniaJackGame:
    """
    Represents the state of a California Jack game.
    
    Attributes:
        player1_hand: Cards in player 1's hand
        player2_hand: Cards in player 2's hand
        stock: The remaining deck (stock pile)
        trump_suit: The trump suit for this hand
        current_player: Which player's turn it is (1 or 2)
        current_trick: The trick currently being played
    """
    
    player1_hand: List[Card] = field(default_factory=list)
    player2_hand: List[Card] = field(default_factory=list)
    stock: Deck = field(default_factory=Deck)
    trump_suit: str = ""
    current_player: int = 1
    current_trick: Optional['Trick'] = None
    
    @classmethod
    def new_game(cls, seed: Optional[int] = None) -> 'CaliforniaJackGame':
        """
        Create a new game with shuffled deck and dealt hands.
        
        According to California Jack rules:
        - Each player gets 6 cards
        - Remaining cards form the stock (face-up, top card visible)
        - Top card of stock determines trump suit
        - Player 1 (non-dealer) leads first
        
        Args:
            seed: Optional random seed for deterministic dealing (useful for testing)
            
        Returns:
            A new CaliforniaJackGame instance ready to play
        """
        # Create and shuffle deck
        deck = Deck()
        deck.shuffle(seed=seed)
        
        # Deal 6 cards to each player (opponent/player1 first per rules)
        player1_hand = deck.deal(6)
        player2_hand = deck.deal(6)
        
        # Remaining 40 cards form the stock
        # Top card determines trump suit
        top_card = deck.top_card()
        trump_suit = top_card.suit if top_card else ""
        
        return cls(
            player1_hand=player1_hand,
            player2_hand=player2_hand,
            stock=deck,
            trump_suit=trump_suit,
            current_player=1  # Player 1 (non-dealer) leads first
        )
    
    def _get_hand(self, player: int) -> List[Card]:
        """Get the hand for the specified player."""
        return self.player1_hand if player == 1 else self.player2_hand
    
    def _has_suit(self, player: int, suit: str) -> bool:
        """Check if player has any cards of the given suit."""
        hand = self._get_hand(player)
        return any(card.suit == suit for card in hand)
    
    def can_play_card(self, player: int, card: Card) -> bool:
        """
        Check if a card is a legal play.
        
        California Jack follow rules:
        1. Lead player can play any card
        2. Follow player must follow suit if able
        3. If cannot follow suit, must trump if able
        4. If cannot follow or trump, can play any card
        
        Args:
            player: Player number (1 or 2)
            card: Card to check
            
        Returns:
            True if the card is a legal play
        """
        hand = self._get_hand(player)
        
        # Card must be in player's hand
        if card not in hand:
            return False
        
        # If no current trick or player is leading, any card is valid
        if self.current_trick is None or self.current_trick.lead_card is None:
            return True
        
        lead_suit = self.current_trick.lead_card.suit
        
        # Must follow suit if able
        if self._has_suit(player, lead_suit):
            return card.suit == lead_suit
        
        # If cannot follow suit, must trump if able
        if self._has_suit(player, self.trump_suit):
            return card.suit == self.trump_suit
        
        # Cannot follow or trump - any card is valid
        return True
    
    def play_card(self, player: int, card: Card) -> None:
        """
        Play a card from the player's hand.
        
        Args:
            player: Player number (1 or 2)
            card: Card to play
            
        Raises:
            ValueError: If the play is illegal
        """
        # Import here to avoid circular import
        from game.models.trick import Trick
        
        if not self.can_play_card(player, card):
            raise ValueError(f"Illegal play: {card}")
        
        # Remove card from hand
        hand = self._get_hand(player)
        hand.remove(card)
        
        # Add to current trick
        if self.current_trick is None or self.current_trick.lead_card is None:
            # Starting a new trick
            self.current_trick = Trick(lead_player=player)
            self.current_trick.lead_card = card
        else:
            # Following in current trick
            self.current_trick.follow_card = card
        
        # Switch to other player
        self.current_player = 2 if player == 1 else 1
    
    def resolve_trick(self) -> int:
        """
        Resolve the current trick and determine winner.
        
        Returns:
            Player number (1 or 2) who won the trick
        """
        if self.current_trick is None or not self.current_trick.is_complete():
            raise ValueError("Cannot resolve incomplete trick")
        
        winner = self.current_trick.winner(self.trump_suit)
        
        # Winner leads next trick
        self.current_player = winner
        
        # Clear current trick
        self.current_trick = None
        
        return winner
    
    def draw_cards(self, winner: int) -> None:
        """
        Draw cards from stock after a trick.
        
        Winner draws first, loser draws second.
        
        Args:
            winner: Player number who won the trick
        """
        if len(self.stock) == 0:
            return
        
        loser = 2 if winner == 1 else 1
        
        # Winner draws first
        winner_card = self.stock.draw()
        if winner_card:
            winner_hand = self._get_hand(winner)
            winner_hand.append(winner_card)
        
        # Loser draws second
        loser_card = self.stock.draw()
        if loser_card:
            loser_hand = self._get_hand(loser)
            loser_hand.append(loser_card)
    
    def is_game_over(self) -> bool:
        """
        Check if the game is over.
        
        Game ends when all 52 cards have been played
        (stock empty AND both hands empty).
        
        Returns:
            True if the game is over
        """
        return (
            len(self.stock) == 0 and
            len(self.player1_hand) == 0 and
            len(self.player2_hand) == 0
        )
